<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="HandheldFriendly" content="true">
  <meta name="MobileOptimized" content="width">
  <title>Profil - GiftFreebies</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Telegram Web App SDK - WAJIB DI HEAD -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">üéÅ GiftFreebies</div>
            <div class="nav-links">
                <a href="index.html">GIVEAWAYS</a>
                <a href="profile.html" class="active">PROFIL</a>
            </div>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">
                    <span class="avatar-initial">?</span>
                </div>
                <span id="userName">Loading...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="profile-container">
            <div class="profile-header">
                <img src="https://via.placeholder.com/120" alt="Profile" class="profile-avatar" id="profileAvatar">
                <div class="profile-title">
                    <h1 id="profileFullname">Loading...</h1>
                    <p id="profileUsername">@loading</p>
                    <p id="profileBio">Member since 2024</p>
                </div>
            </div>

            <button class="create-giveaway-btn" onclick="window.location.href='create-giveaway.html'">
                <svg viewBox="0 0 24 24" width="24" height="24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                CREATE GIVEAWAY
            </button>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalGiveaways">0</div>
                    <div class="stat-label">Giveaway Dibuat</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalParticipations">0</div>
                    <div class="stat-label">Partisipasi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalWins">0</div>
                    <div class="stat-label">Kemenangan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTickets">0</div>
                    <div class="stat-label">Total Tiket</div>
                </div>
            </div>

            <h2 style="margin: 2rem 0 1rem;">Giveaway Saya</h2>
            <div id="userGiveaways" class="giveaway-list">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEMUA JAVASCRIPT DIGABUNG DI SINI, TIDAK PAKAI FILE EKSTERNAL -->
    <script>
        // ================================
        // TELEGRAM USER AUTH - LANGSUNG DI HTML
        // ================================
        
        (function() {
            console.log('üöÄ Telegram.js started (inline)');

            // ==================== KONFIGURASI API ====================
            const API_URL = 'https://individually-threaded-jokes-letting.trycloudflare.com';

            // Global variables
            window.currentUser = null;
            window.telegramUser = null;

            // ==================== FUNGSI UTILITY ====================
            function formatDate(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function showLoading(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    `;
                }
            }

            function showError(containerId, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-error">‚ùå ${message}</div>
                    `;
                }
            }

            // ==================== API CALLS ====================
            async function apiCall(endpoint, method = 'GET', data = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    console.log(`üîç API Call: ${method} ${endpoint}`, data || '');
                    const response = await fetch(`${API_URL}${endpoint}`, options);
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'API call failed');
                    }

                    console.log(`‚úÖ API Success: ${method} ${endpoint}`, result);
                    return result;
                } catch (error) {
                    console.error('‚ùå API Error:', error);
                    throw error;
                }
            }

            // Generate avatar fallback
            function generateAvatar(name = "User") {
                return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1e88e5&color=fff&size=128&bold=true`;
            }

            // Update UI
            function updateUserUI() {
                if (!window.currentUser) return;

                console.log('üñºÔ∏è Updating UI for user:', window.currentUser);

                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');
                const profileFullname = document.getElementById('profileFullname');
                const profileUsername = document.getElementById('profileUsername');
                const profileAvatar = document.getElementById('profileAvatar');
                const profileBio = document.getElementById('profileBio');

                if (userNameEl) {
                    userNameEl.textContent = window.currentUser.fullname || window.currentUser.username || 'User';
                }

                if (userAvatarEl) {
                    userAvatarEl.innerHTML = '';
                    
                    if (window.currentUser.avatar && !window.currentUser.avatar.includes('ui-avatars')) {
                        const img = document.createElement('img');
                        img.src = window.currentUser.avatar;
                        img.alt = window.currentUser.fullname || 'User';
                        img.style = 'width:100%;height:100%;border-radius:50%;object-fit:cover;';
                        userAvatarEl.appendChild(img);
                    } else {
                        const initial = (window.currentUser.fullname || 'U').charAt(0).toUpperCase();
                        userAvatarEl.innerHTML = `<span class="avatar-initial">${initial}</span>`;
                    }
                }

                if (profileFullname) {
                    profileFullname.textContent = window.currentUser.fullname || 'No Name';
                }

                if (profileUsername) {
                    profileUsername.textContent = window.currentUser.username ? `@${window.currentUser.username}` : '-';
                }

                if (profileAvatar) {
                    if (window.currentUser.avatar && !window.currentUser.avatar.includes('ui-avatars')) {
                        profileAvatar.src = window.currentUser.avatar;
                    } else {
                        profileAvatar.src = generateAvatar(window.currentUser.fullname);
                    }
                }

                if (profileBio) {
                    profileBio.textContent = window.currentUser.is_premium ? '‚≠ê Premium User' : 'Free User';
                }
            }

            // Load user profile data
            async function loadUserProfile() {
                console.log('üìã Loading profile page...');
                console.log('Current user:', window.currentUser);

                if (!window.currentUser) {
                    showError('userGiveaways', 'Silakan login terlebih dahulu');
                    return;
                }

                showLoading('userGiveaways');

                try {
                    // Update profile details
                    if (window.currentUser.user_id && window.currentUser.user_id !== 7998861975) {
                        try {
                            console.log('üìä Fetching stats for user_id:', window.currentUser.user_id);
                            const stats = await apiCall(`/api/user/${window.currentUser.user_id}/stats`);
                            
                            const totalGiveaways = document.getElementById('totalGiveaways');
                            const totalParticipations = document.getElementById('totalParticipations');
                            const totalWins = document.getElementById('totalWins');
                            const totalTickets = document.getElementById('totalTickets');
                            
                            if (totalGiveaways) totalGiveaways.textContent = stats.total_giveaways || 0;
                            if (totalParticipations) totalParticipations.textContent = stats.total_participations || 0;
                            if (totalWins) totalWins.textContent = stats.total_wins || 0;
                            if (totalTickets) totalTickets.textContent = stats.total_tickets || 0;
                            
                        } catch (error) {
                            console.warn('Stats API error, using defaults:', error);
                        }

                        try {
                            console.log('üéÅ Fetching giveaways for user_id:', window.currentUser.user_id);
                            const giveaways = await apiCall(`/api/user/${window.currentUser.user_id}/giveaways`);
                            
                            const container = document.getElementById('userGiveaways');
                            if (!container) return;

                            if (!giveaways || giveaways.length === 0) {
                                container.innerHTML = '<div class="alert alert-info">Belum ada giveaway yang dibuat</div>';
                                return;
                            }

                            container.innerHTML = giveaways.map(giveaway => {
                                const status = giveaway.status === 'active' ? 'Aktif' : 'Berakhir';
                                const statusClass = giveaway.status === 'active' ? 'success' : 'secondary';

                                return `
                                    <div class="giveaway-item" onclick="window.location.href='giveaway.html?giveaway_id=${giveaway.giveaway_id}'">
                                        <div>
                                            <h4>üéÅ ${giveaway.prize}</h4>
                                            <p>üë• ${giveaway.participants_count || 0} peserta</p>
                                            <small>Dibuat: ${formatDate(giveaway.created_at)}</small>
                                        </div>
                                        <div>
                                            <span class="giveaway-status status-${statusClass}">${status}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                        } catch (error) {
                            console.warn('Giveaways API error:', error);
                            document.getElementById('userGiveaways').innerHTML =
                                '<div class="alert alert-info">Tidak dapat memuat giveaway</div>';
                        }
                    } else {
                        // Guest user
                        document.getElementById('userGiveaways').innerHTML =
                            '<div class="alert alert-info">Login untuk melihat giveaway Anda</div>';
                    }

                } catch (error) {
                    console.error('Error loading profile:', error);
                    showError('userGiveaways', 'Gagal memuat data profil: ' + error.message);
                }
            }

            // Init Telegram WebApp
            function initTelegramAuth() {
                console.log('üîç Initializing Telegram Auth...');

                if (window.Telegram && window.Telegram.WebApp) {
                    console.log('‚úÖ Telegram WebApp detected');

                    const tg = window.Telegram.WebApp;
                    tg.expand();
                    tg.ready();

                    console.log('Telegram WebApp version:', tg.version);
                    console.log('initDataUnsafe:', tg.initDataUnsafe);

                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        const user = tg.initDataUnsafe.user;
                        window.telegramUser = user;

                        console.log("‚úÖ Telegram user detected:", user);

                        window.currentUser = {
                            user_id: user.id,
                            fullname: `${user.first_name || ""} ${user.last_name || ""}`.trim(),
                            username: user.username || "",
                            avatar: user.photo_url || generateAvatar(user.first_name),
                            first_seen: new Date().toISOString(),
                            is_premium: user.is_premium || false
                        };

                        console.log('‚úÖ currentUser set:', window.currentUser);

                        // Update UI
                        updateUserUI();

                        // Load profile data
                        loadUserProfile();

                    } else {
                        console.warn("‚ùå Telegram user data not available");
                        setGuestUser();
                    }
                } else {
                    console.warn("‚ùå Not opened inside Telegram");
                    setGuestUser();
                }
            }

            // Guest fallback
            function setGuestUser() {
                window.currentUser = {
                    user_id: 7998861975,
                    fullname: 'Guest',
                    username: 'guest',
                    avatar: generateAvatar('Guest'),
                    first_seen: new Date().toISOString(),
                    is_premium: false
                };
                window.telegramUser = null;

                console.log('üë§ Guest user set');
                updateUserUI();
                loadUserProfile();
            }

            // JALANKAN LANGSUNG
            initTelegramAuth();
        })();
    </script>
</body>
</html>
